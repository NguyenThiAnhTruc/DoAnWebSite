<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Đăng nhập • SchoolEvents</title>

  <!-- Tailwind CDN cho style nhanh gọn (không cần build) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class'
    }
  </script>

  <style>
    /* Toast đơn giản */
    .toast {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: #111827; /* gray-900 */
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 14px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease, transform .2s ease;
      z-index: 9999;
      box-shadow: 0 8px 24px rgba(0,0,0,.15);
    }
    .toast.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) translateY(0);
    }

    /* Hiệu ứng vào màn hình */
    .fade-up {
      opacity: 0;
      transform: translateY(20px);
      animation: fadeUp .6s ease forwards;
    }
    @keyframes fadeUp {
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 flex items-center justify-center px-4">

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <div class="w-full max-w-md fade-up">
    <!-- Logo -->
    <div class="text-center mb-8">
      <a href="/" class="inline-flex items-center space-x-3">
        <img src="/images/logo-dai-hoc-da-lat.jpg" alt="Logo Đại học Đà Lạt" class="w-16 h-16 object-contain rounded-full">
        <span class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
          SchoolEvents
        </span>
      </a>
    </div>

    <!-- Card -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 border border-gray-100 fade-up" style="animation-delay: .05s;">
      <div class="text-center mb-8">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white dark:text-white mb-2">Đăng nhập</h2>
        <p class="text-gray-600 dark:text-gray-300">Chào mừng bạn trở lại với SchoolEvents</p>
      </div>


      <!-- Form -->
      <form id="loginForm" class="space-y-6" autocomplete="on" novalidate>
        <!-- Username/Email -->
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Email hoặc Username</label>
          <div class="relative">
            <!-- User icon -->
            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
            <input id="username" name="username" type="text" placeholder="Nhập email hoặc username"
                   class="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
                   required />
          </div>
        </div>

        <!-- Password -->
        <div>
          <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Mật khẩu</label>
          <div class="relative">
            <!-- Lock icon -->
            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c-1.657 0-3 1.343-3 3v3h6v-3c0-1.657-1.343-3-3-3z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 11V9a5 5 0 10-10 0v2M5 21h14a2 2 0 002-2v-5a2 2 0 00-2-2H5a2 2 0 00-2 2v5a2 2 0 002 2z"/>
            </svg>
            <input id="password" name="password" type="password" placeholder="Nhập mật khẩu"
                   class="w-full pl-10 pr-12 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
                   required />
            <button type="button" id="togglePassword"
                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:text-gray-300"
                    aria-label="Hiện/ẩn mật khẩu">
              <!-- Eye icon (toggle bằng JS) -->
              <svg id="eyeOpen" class="w-5 h-5 block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
              <svg id="eyeOff" class="w-5 h-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7a9.97 9.97 0 012.221-3.568m3.213-2.227A9.956 9.956 0 0112 5c4.477 0 8.268 2.943 9.542 7a9.97 9.97 0 01-1.257 2.31M15 12a3 3 0 00-3-3m0 0a3 3 0 013 3m-3-3L3 21" />
              </svg>
            </button>
          </div>
        </div>

        <!-- Remember / Forgot -->
        <div class="flex items-center justify-between">
          <label class="flex items-center">
            <input id="remember" type="checkbox" class="w-4 h-4 text-blue-600 rounded border-gray-300 dark:border-gray-600 focus:ring-blue-500">
            <span class="ml-2 text-sm text-gray-600 dark:text-gray-300">Ghi nhớ đăng nhập</span>
          </label>
          <a href="#" class="text-sm text-blue-600 hover:text-blue-500">Quên mật khẩu?</a>
        </div>

        <!-- Submit -->
        <button id="submitBtn" type="submit"
                class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-xl font-semibold hover:shadow-lg transition-all flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
          <span id="btnLabel" class="inline-flex items-center">
            Đăng nhập
            <svg class="w-5 h-5 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
            </svg>
          </span>
          <span id="btnSpinner" class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
        </button>
      </form>

      <div class="mt-8 text-center">
        <p class="text-gray-600 dark:text-gray-300">
          Chưa có tài khoản?
          <a href="Register.html" class="text-blue-600 hover:text-blue-500 font-medium">Đăng ký ngay</a>
        </p>
      </div>
    </div>

    <div class="mt-6 text-center">
      <a href="/" class="text-gray-600 dark:text-gray-300 hover:text-blue-600 transition-colors flex items-center justify-center">
        ← Quay lại trang chủ
      </a>
    </div>
  </div>

  <script>
    // ====== CẤU HÌNH API ======
    const API_BASE_URL = window.ENV_API_BASE_URL || '';
    // Sử dụng relative URL để tránh CSP issues, vì trang đã được phục vụ từ cùng server

    const $ = (sel) => document.querySelector(sel);
    const toastEl = $('#toast');

    function toast(message, type = 'info', duration = 2200) {
      toastEl.textContent = message;
      toastEl.style.background = type === 'error' ? '#DC2626' /* red-600 */
                              : type === 'success' ? '#16A34A' /* green-600 */
                              : '#111827';
      toastEl.classList.add('show');
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => toastEl.classList.remove('show'), duration);
    }

    // Toggle show/hide password
    $('#togglePassword').addEventListener('click', () => {
      const pwd = $('#password');
      const isText = pwd.type === 'text';
      pwd.type = isText ? 'password' : 'text';
      $('#eyeOpen').classList.toggle('hidden', !isText);
      $('#eyeOff').classList.toggle('hidden', isText);
    });

    // Pre-fill từ localStorage nếu "ghi nhớ"
    window.addEventListener('DOMContentLoaded', () => {
      try {
        const remembered = JSON.parse(localStorage.getItem('remember_login') || 'null');
        if (remembered?.email) {
          $('#email').value = remembered.email;
          $('#remember').checked = true;
        }
      } catch {}
    });

    // Submit form
    $('#loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = $('#username').value.trim();
      const password = $('#password').value;

      if (!username || !password) {
        toast('Vui lòng điền đầy đủ thông tin', 'error');
        return;
      }

      const submitBtn = $('#submitBtn');
      const btnLabel = $('#btnLabel');
      const btnSpinner = $('#btnSpinner');
      submitBtn.disabled = true;
      btnLabel.classList.add('hidden');
      btnSpinner.classList.remove('hidden');

      try {
        const res = await fetch(`${API_BASE_URL}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        if (!res.ok) {
          // cố gắng đọc message từ server
          let msg = 'Email hoặc mật khẩu không đúng';
          try {
            const j = await res.json();
            if (j?.message) msg = j.message;
          } catch {}
          throw new Error(msg);
        }

        const data = await res.json(); // { token, user }
        // Lưu token + user
        localStorage.setItem('token', data.token);
        localStorage.setItem('user', JSON.stringify(data.user));
        localStorage.setItem('currentUser', JSON.stringify(data.user));
        localStorage.setItem('auth_token_user', data.token);

        // Load theme và language từ user data
        if (data.user.theme && window.ThemeService) {
          ThemeService.applyTheme(data.user.theme);
        }
        if (data.user.language) {
          localStorage.setItem('app_language', data.user.language);
        }

        // Ghi nhớ username nếu tick
        if ($('#remember').checked) {
          localStorage.setItem('remember_login', JSON.stringify({ username }));
        } else {
          localStorage.removeItem('remember_login');
        }

        toast('Đăng nhập thành công!', 'success');
        // Lưu thêm các key để tương thích với các script khác trong project
        try {
          // data.user.role nên là 'student' | 'admin' | 'teacher'
          localStorage.setItem('token', data.token);
          localStorage.setItem('user', JSON.stringify(data.user));
          // Có vài file trong project dùng key khác -> duy trì để tương thích
          localStorage.setItem('currentUser', JSON.stringify(data.user));
          localStorage.setItem('auth_token_user', JSON.stringify({ token: data.token, user: data.user }));
        } catch (e) { /* ignore storage errors */ }

        // Điều hướng theo role: student -> EventList, admin/teacher -> dashboard
        setTimeout(() => {
          const role = (data.user?.role || '').toLowerCase();
          if (role === 'student') {
            window.location.href = '/EventList.html';
          } else if (role === 'teacher' || role === 'admin') {
            // Keep existing route for admin/teacher
            window.location.href = '/dashboard';
          } else {
            // fallback
            window.location.href = '/dashboard';
          }
        }, 400);
      } catch (err) {
        toast(err.message || 'Có lỗi xảy ra, vui lòng thử lại', 'error', 2600);
      } finally {
        submitBtn.disabled = false;
        btnLabel.classList.remove('hidden');
        btnSpinner.classList.add('hidden');
      }
    });
  </script>
  <script src="/js/theme.js"></script>
</body>
</html>
