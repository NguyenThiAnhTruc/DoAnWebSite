<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test QR Attendance System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="/js/theme.js"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-gray-800">üß™ Test H·ªá Th·ªëng ƒêi·ªÉm Danh QR</h1>
        
        <!-- Test Cases -->
        <div class="space-y-4">
            <!-- Test 1 -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h3 class="text-xl font-semibold mb-2">Test 1: Truy c·∫≠p trang t·∫°o QR</h3>
                        <p class="text-gray-600 mb-4">Ki·ªÉm tra Admin/Gi√°o vi√™n c√≥ th·ªÉ truy c·∫≠p trang t·∫°o m√£ QR</p>
                        <div class="bg-gray-50 p-3 rounded font-mono text-sm mb-3">
                            <strong>URL:</strong> <a href="/qr-attendance" class="text-blue-600 hover:underline">/qr-attendance</a>
                        </div>
                        <div class="text-sm text-gray-500">
                            <strong>Expected:</strong> Hi·ªÉn th·ªã trang v·ªõi 2 tabs: "T·∫°o m√£ QR" v√† "Qu√©t m√£ QR"
                        </div>
                    </div>
                    <span id="status1" class="text-2xl">‚è≥</span>
                </div>
                <button onclick="test1()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    Ch·∫°y Test
                </button>
            </div>

            <!-- Test 2 -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h3 class="text-xl font-semibold mb-2">Test 2: T·∫°o m√£ QR</h3>
                        <p class="text-gray-600 mb-4">Ki·ªÉm tra vi·ªác t·∫°o m√£ QR cho s·ª± ki·ªán</p>
                        <div class="bg-gray-50 p-3 rounded font-mono text-sm mb-3">
                            <strong>Steps:</strong><br>
                            1. V√†o /qr-attendance<br>
                            2. Ch·ªçn s·ª± ki·ªán t·ª´ dropdown<br>
                            3. Ki·ªÉm tra m√£ QR xu·∫•t hi·ªán
                        </div>
                        <div class="text-sm text-gray-500">
                            <strong>Expected:</strong> M√£ QR hi·ªÉn th·ªã v·ªõi URL ch·ª©a eventId
                        </div>
                    </div>
                    <span id="status2" class="text-2xl">‚è≥</span>
                </div>
                <button onclick="test2()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    Ch·∫°y Test
                </button>
            </div>

            <!-- Test 3 -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h3 class="text-xl font-semibold mb-2">Test 3: Parse QR Data</h3>
                        <p class="text-gray-600 mb-4">Ki·ªÉm tra vi·ªác parse d·ªØ li·ªáu t·ª´ m√£ QR</p>
                        <div class="bg-gray-50 p-3 rounded font-mono text-sm mb-3">
                            <strong>Input:</strong> "e1|checkin|1697500000000"<br>
                            <strong>Expected Output:</strong><br>
                            - eventId: "e1"<br>
                            - action: "checkin"<br>
                            - timestamp: 1697500000000
                        </div>
                    </div>
                    <span id="status3" class="text-2xl">‚è≥</span>
                </div>
                <button onclick="test3()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    Ch·∫°y Test
                </button>
                <div id="result3" class="mt-3 p-3 bg-gray-50 rounded hidden"></div>
            </div>

            <!-- Test 4 -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h3 class="text-xl font-semibold mb-2">Test 4: Trang ƒëƒÉng nh·∫≠p sinh vi√™n</h3>
                        <p class="text-gray-600 mb-4">Ki·ªÉm tra trang StudentQRLogin.html nh·∫≠n QR data</p>
                        <div class="bg-gray-50 p-3 rounded font-mono text-sm mb-3">
                            <strong>URL:</strong> <a href="/StudentQRLogin.html?qr=e1|checkin|1697500000000" target="_blank" class="text-blue-600 hover:underline">
                                /StudentQRLogin.html?qr=e1|checkin|1697500000000
                            </a>
                        </div>
                        <div class="text-sm text-gray-500">
                            <strong>Expected:</strong> Hi·ªÉn th·ªã form ƒëƒÉng nh·∫≠p v·ªõi th√¥ng tin s·ª± ki·ªán "H·ªôi th·∫£o AI"
                        </div>
                    </div>
                    <span id="status4" class="text-2xl">‚è≥</span>
                </div>
                <button onclick="test4()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    M·ªü trang
                </button>
            </div>

            <!-- Test 5 -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h3 class="text-xl font-semibold mb-2">Test 5: ƒêi·ªÉm danh v·ªõi localStorage</h3>
                        <p class="text-gray-600 mb-4">Ki·ªÉm tra vi·ªác l∆∞u v√† ki·ªÉm tra ƒëi·ªÉm danh tr√πng l·∫∑p</p>
                        <div class="bg-gray-50 p-3 rounded font-mono text-sm mb-3">
                            <strong>Steps:</strong><br>
                            1. Mock login v·ªõi email: student@school.edu<br>
                            2. ƒêi·ªÉm danh s·ª± ki·ªán e1<br>
                            3. Th·ª≠ ƒëi·ªÉm danh l·∫°i ‚Üí Should fail (duplicate)
                        </div>
                    </div>
                    <span id="status5" class="text-2xl">‚è≥</span>
                </div>
                <button onclick="test5()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    Ch·∫°y Test
                </button>
                <div id="result5" class="mt-3 p-3 bg-gray-50 rounded hidden"></div>
            </div>

            <!-- Test 6 -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h3 class="text-xl font-semibold mb-2">Test 6: Auto-register</h3>
                        <p class="text-gray-600 mb-4">Ki·ªÉm tra t·ª± ƒë·ªông ƒëƒÉng k√Ω khi sinh vi√™n ch∆∞a ƒëƒÉng k√Ω s·ª± ki·ªán</p>
                        <div class="bg-gray-50 p-3 rounded font-mono text-sm mb-3">
                            <strong>Scenario:</strong> Sinh vi√™n qu√©t QR nh∆∞ng ch∆∞a ƒëƒÉng k√Ω s·ª± ki·ªán<br>
                            <strong>Expected:</strong> T·ª± ƒë·ªông ƒëƒÉng k√Ω + ƒëi·ªÉm danh
                        </div>
                    </div>
                    <span id="status6" class="text-2xl">‚è≥</span>
                </div>
                <button onclick="test6()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    Ch·∫°y Test
                </button>
                <div id="result6" class="mt-3 p-3 bg-gray-50 rounded hidden"></div>
            </div>
        </div>

        <!-- Clear Data -->
        <div class="mt-8 bg-red-50 border border-red-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-red-800 mb-2">‚ö†Ô∏è Reset Test Data</h3>
            <p class="text-red-700 mb-4">X√≥a t·∫•t c·∫£ d·ªØ li·ªáu test trong localStorage</p>
            <button onclick="clearData()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                X√≥a d·ªØ li·ªáu
            </button>
        </div>
    </div>

    <script>
        // Mock data
        const events = [
            { id: 'e1', title: 'H·ªôi th·∫£o AI', date: '2025-10-15', time: '08:00', location: 'H·ªôi tr∆∞·ªùng A' },
            { id: 'e2', title: 'Giao l∆∞u T√¢n SV', date: '2025-10-20', time: '14:00', location: 'S√¢n tr∆∞·ªùng' }
        ];

        const users = [
            { id: '1', email: 'student@school.edu', name: 'Nguy·ªÖn VƒÉn An', role: 'student' }
        ];

        // Helper functions
        function parseQRData(str) {
            const parts = String(str || '').split('|');
            if (parts.length !== 3 || parts[1] !== 'checkin') return null;
            return { eventId: parts[0], action: parts[1], timestamp: parseInt(parts[2]) || 0 };
        }

        function getAttendance() {
            try { return JSON.parse(localStorage.getItem('attendance_records') || '[]'); }
            catch { return []; }
        }

        function saveAttendance(list) {
            localStorage.setItem('attendance_records', JSON.stringify(list));
        }

        function getRegistrations() {
            try { return JSON.parse(localStorage.getItem('registrations') || '[]'); }
            catch { return []; }
        }

        function saveRegistrations(list) {
            localStorage.setItem('registrations', JSON.stringify(list));
        }

        // Test functions
        function test1() {
            window.open('/qr-attendance', '_blank');
            document.getElementById('status1').textContent = '‚úÖ';
        }

        function test2() {
            window.open('/qr-attendance', '_blank');
            alert('Vui l√≤ng:\n1. Ch·ªçn s·ª± ki·ªán t·ª´ dropdown\n2. Ki·ªÉm tra m√£ QR xu·∫•t hi·ªán\n3. Click "T·∫£i xu·ªëng" ƒë·ªÉ l∆∞u m√£ QR');
            document.getElementById('status2').textContent = '‚úÖ';
        }

        function test3() {
            const testData = 'e1|checkin|1697500000000';
            const parsed = parseQRData(testData);
            const result = document.getElementById('result3');
            
            if (parsed && parsed.eventId === 'e1' && parsed.action === 'checkin') {
                result.innerHTML = `
                    <strong>‚úÖ PASS</strong><br>
                    EventId: ${parsed.eventId}<br>
                    Action: ${parsed.action}<br>
                    Timestamp: ${parsed.timestamp}
                `;
                result.classList.remove('hidden');
                result.classList.add('bg-green-50', 'text-green-800');
                document.getElementById('status3').textContent = '‚úÖ';
            } else {
                result.innerHTML = '<strong>‚ùå FAIL</strong><br>Parse kh√¥ng th√†nh c√¥ng';
                result.classList.remove('hidden');
                result.classList.add('bg-red-50', 'text-red-800');
                document.getElementById('status3').textContent = '‚ùå';
            }
        }

        function test4() {
            window.open('/StudentQRLogin.html?qr=e1|checkin|1697500000000', '_blank');
            document.getElementById('status4').textContent = '‚úÖ';
        }

        function test5() {
            // Clear first
            localStorage.removeItem('attendance_records');
            
            const user = users[0];
            const eventId = 'e1';
            
            // First attendance
            let atts = getAttendance();
            const existed = atts.find(a => a.eventId === eventId && a.userId === user.id);
            
            if (!existed) {
                atts.push({ eventId, userId: user.id, status: 'present', method: 'QR Code' });
                saveAttendance(atts);
            }
            
            // Try duplicate
            atts = getAttendance();
            const duplicate = atts.find(a => a.eventId === eventId && a.userId === user.id);
            
            const result = document.getElementById('result5');
            if (duplicate) {
                result.innerHTML = `
                    <strong>‚úÖ PASS</strong><br>
                    - ƒêi·ªÉm danh l·∫ßn 1: Th√†nh c√¥ng<br>
                    - ƒêi·ªÉm danh l·∫ßn 2: Ph√°t hi·ªán tr√πng l·∫∑p (ƒë√∫ng)<br>
                    - D·ªØ li·ªáu trong localStorage: ${atts.length} record
                `;
                result.classList.remove('hidden');
                result.classList.add('bg-green-50', 'text-green-800');
                document.getElementById('status5').textContent = '‚úÖ';
            } else {
                result.innerHTML = '<strong>‚ùå FAIL</strong><br>Kh√¥ng ph√°t hi·ªán tr√πng l·∫∑p';
                result.classList.remove('hidden');
                result.classList.add('bg-red-50', 'text-red-800');
                document.getElementById('status5').textContent = '‚ùå';
            }
        }

        function test6() {
            // Clear first
            localStorage.removeItem('registrations');
            
            const user = users[0];
            const eventId = 'e1';
            const event = events[0];
            
            // Check registration
            let regs = getRegistrations();
            let reg = regs.find(r => r.eventId === eventId && r.userId === user.id);
            
            // Auto-register if not exists
            if (!reg) {
                reg = {
                    id: Date.now().toString(),
                    eventId,
                    userId: user.id,
                    userName: user.name,
                    userEmail: user.email,
                    status: 'confirmed',
                    registeredAt: new Date().toISOString()
                };
                regs.push(reg);
                saveRegistrations(regs);
            }
            
            // Verify
            regs = getRegistrations();
            const verified = regs.find(r => r.eventId === eventId && r.userId === user.id);
            
            const result = document.getElementById('result6');
            if (verified) {
                result.innerHTML = `
                    <strong>‚úÖ PASS</strong><br>
                    - T·ª± ƒë·ªông ƒëƒÉng k√Ω th√†nh c√¥ng<br>
                    - User: ${verified.userName}<br>
                    - Event: ${event.title}<br>
                    - Status: ${verified.status}
                `;
                result.classList.remove('hidden');
                result.classList.add('bg-green-50', 'text-green-800');
                document.getElementById('status6').textContent = '‚úÖ';
            } else {
                result.innerHTML = '<strong>‚ùå FAIL</strong><br>Auto-register kh√¥ng th√†nh c√¥ng';
                result.classList.remove('hidden');
                result.classList.add('bg-red-50', 'text-red-800');
                document.getElementById('status6').textContent = '‚ùå';
            }
        }

        function clearData() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu test?')) {
                localStorage.removeItem('attendance_records');
                localStorage.removeItem('registrations');
                alert('‚úÖ ƒê√£ x√≥a d·ªØ li·ªáu test');
                location.reload();
            }
        }

        // Initialize
        lucide.createIcons();
    </script>
</body>
</html>
